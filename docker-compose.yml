services:
  # Fails fast if FEEDLAND_DOMAIN is missing or still the example value.
  check:
    image: alpine:3.20
    environment:
      FEEDLAND_DOMAIN: ${FEEDLAND_DOMAIN:?You must set FEEDLAND_DOMAIN in .env}
    command: >
      sh -lc '
        if [ -z "$FEEDLAND_DOMAIN" ]; then
          echo "FEEDLAND_DOMAIN is not set. Set it in .env.";
          exit 1;
        fi;
        if [ "$FEEDLAND_DOMAIN" = "feedland.example.com" ]; then
          echo "FEEDLAND_DOMAIN is still the example value. Edit .env and set a real hostname.";
          exit 1;
        fi;
        echo "FEEDLAND_DOMAIN looks good: $FEEDLAND_DOMAIN";
      '
    restart: "no"

  feedland:
    image: ghcr.io/scotthansonde/feedlandtest
    depends_on:
      check:
        condition: service_completed_successfully
      mysql:
        condition: service_healthy
    environment:
      - TZ=Europe/Berlin
    volumes:
      - feedland_data:/project/privateFiles
    ports:
      - "1452:1452"
      - "1462:1462"
    restart: unless-stopped

  mysql:
    image: mysql:8.4
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:?Set MYSQL_ROOT_PASSWORD in .env}
      MYSQL_DATABASE: feedland
      MYSQL_USER: feedland
      MYSQL_PASSWORD: ${MYSQL_USER_PASSWORD:?Set MYSQL_USER_PASSWORD in .env}
    volumes:
      - mysql_data:/var/lib/mysql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Optional HTTPS reverse proxy. Enable by setting COMPOSE_PROFILES=caddy in .env
  caddy:
    image: caddy:2
    profiles: ["caddy"]
    depends_on:
      check:
        condition: service_completed_successfully
      feedland:
        condition: service_started
    environment:
      FEEDLAND_DOMAIN: ${FEEDLAND_DOMAIN}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped

volumes:
  mysql_data:
  feedland_data:
  caddy_data:
  caddy_config:
